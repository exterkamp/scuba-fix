addEventListener("message",({data:a})=>{console.log(`We have a request, ${JSON.stringify(a)}`);let t=a;switch(t.type){case 2:let r=G(t.bitmap);postMessage({type:2,result:2,filter:r});break;case 4:let s=JSON.parse(t.filter),e=P(t.bitmap,s);postMessage({type:4,result:2,imageData:e});break;default:postMessage({type:3,message:"Unknown requested work type."})}});function M(a){let r=new OffscreenCanvas(a.width,a.height).getContext("2d");return r.drawImage(a,0,0),r.getImageData(0,0,a.width,a.height)}function G(a){let t=M(a),r=t.data,s=t.width,e=t.height,c=s*e/2e3,k=60,B=120,A=1.2,g={r:[],g:[],b:[]},i={r:[],g:[],b:[]},u={r:{low:0,high:255},g:{low:0,high:255},b:{low:0,high:255}},p=0;for(let n=0;n<256;n++)g.r.push(0),g.g.push(0),g.b.push(0);let h=H(r,s,e),b=h.r;for(;b<k;){let n=C(h.r,h.g,h.b,p);b=n.r+n.g+n.b,p++,p>B&&(b=60)}for(let n=0;n<e;n++)for(let F=0;F<s*4;F+=4){let R=F+s*4*n,m=Math.round(r[R+0]),S=Math.round(r[R+1]),D=Math.round(r[R+2]),w=C(m,S,D,p);m=w.r+w.g+w.b,m=Math.min(255,Math.max(0,m)),m=Math.round(m),g.r[m]+=1,g.g[S]+=1,g.b[D]+=1}i.r.push(0),i.g.push(0),i.b.push(0);for(let n=0;n<256;n++)g.r[n]-c<2&&i.r.push(n),g.g[n]-c<2&&i.g.push(n),g.b[n]-c<2&&i.b.push(n);i.r.push(255),i.g.push(255),i.b.push(255),u.r=I(i.r),u.g=I(i.g),u.b=I(i.b);let d=C(1,1,1,p),f=256/(u.r.high-u.r.low),y=256/(u.g.high-u.g.low),x=256/(u.b.high-u.b.low),q=-u.r.low/256*f,v=-u.g.low/256*y,U=-u.b.low/256*x,O=d.r*f,W=d.g*f,j=d.b*f*A;return{red:{r:O,g:W,b:j,a:0,offset:q},green:{r:0,g:y,b:0,a:0,offset:v},blue:{r:0,g:0,b:x,a:0,offset:U},alpha:{r:0,g:0,b:0,a:1,offset:0}}}function H(a,t,r){let s=Date.now(),e={r:0,g:0,b:0};for(let o=0;o<r;o++)for(let l=0;l<t*4;l+=4){let c=l+t*4*o;e.r=e.r+a[c+0],e.g=e.g+a[c+1],e.b=e.b+a[c+2]}return e.r=e.r/(t*r),e.g=e.g/(t*r),e.b=e.b/(t*r),console.log(`Average color: ${JSON.stringify(e)}`),console.log(`Average color calculation took ${Date.now()-s}ms`),e}function C(a,t,r,s){let e=Math.cos(s*Math.PI/180),o=Math.sin(s*Math.PI/180);return a=(.299+.701*e+.168*o)*a,t=(.587-.587*e+.33*o)*t,r=(.114-.114*e-.497*o)*r,{r:a,g:t,b:r}}function I(a){let t=255,r=0,s=0;for(let e=1;e<a.length;e++){let o=a[e]-a[e-1];o>s&&(s=o,t=a[e],r=a[e-1])}return{low:r,high:t}}function P(a,t){let r=M(a),s=new Uint8ClampedArray(r.data),e=r.data;for(let l=0;l<e.length;l+=4)s[l]=Math.min(255,Math.max(0,e[l]*t.red.r+e[l+1]*t.red.g+e[l+2]*t.red.b+t.red.offset*255)),s[l+1]=Math.min(255,Math.max(0,e[l+1]*t.green.g+t.green.offset*255)),s[l+2]=Math.min(255,Math.max(0,e[l+2]*t.blue.b+t.blue.offset*255));return new ImageData(s,r.width,r.height)}
